# SPDX-FileCopyrightText: 2024 Roy Wright
#
# SPDX-License-Identifier: MIT

version: "3"

vars:
  POETRY_RUNNER: poetry run --
  POETRY_DEV_RUNNER: "{{.POETRY_RUNNER}}"
  POETRY_DOCS_RUNNER: "{{.POETRY_RUNNER}}"
  POETRY_TEST_RUNNER: "{{.POETRY_RUNNER}}"
  POETRY_METRICS_RUNNER: "{{.POETRY_RUNNER}}"
  POETRY_SPHINX_RUNNER: "{{.POETRY_RUNNER}}"

tasks:
  make-dist-packages:
    # [private] build dist packages
    cmds:
      - poetry build

  env-prune:
    # [private] remove development environment (i.e. virtual environments)
    cmds:
      - poetry env remove --all

  make-env:
    desc: create virtual environment
    cmds:
      - poetry config virtualenvs.in-project true
      - poetry lock
      - poetry install

  show-env:
    # [private] show env using poetry
    cmds:
      - echo "Creating virtualenv in .venv"
      - poetry env list
      - poetry env info

  unit-tests:
    # [private] Run the unit tests for the supported versions of python.
    cmds:
      # for poetry, tox is used for multiple python testing
      - "{{.POETRY_TEST_RUNNER}} pytest tests"
      - "{{.POETRY_TEST_RUNNER}} tox"

  update-venv:
    cmds:
      # [private] update development virtual environment
      - poetry update
      - "{{.POETRY_DEV_RUNNER}} pip install --upgrade pip"
      # install project into virtual environment
      - poetry install
