# SPDX-FileCopyrightText: 2024 Roy Wright
#
# SPDX-License-Identifier: MIT

version: "3"

vars:
  DEFAULT_RUNNER: hatch run --
  DEV_RUNNER: hatch -e dev run --
  DOCS_RUNNER: hatch -e docs run --
  TEST_RUNNER: hatch -e test run --
  METRICS_RUNNER: hatch -e metrics run --
  SPHINX_RUNNER: hatch -e sphinx run --

tasks:
  make_dist_packages:
    # [private] build dist packages
    cmds:
      - hatch -e dev build

  env_prune:
    # [private] remove development environment (i.e. virtual environments)
    cmds:
      - hatch env prune

  show-env:
    # [private] show this front ends environment
    cmds:
      - task: hatch-show-env

  hatch-show-env:
    # [private] show the environment using hatch
    cmds:
      - echo "Creating virtualenv in .venv"
      - python --version
      - hatch env show

  poetry-show-env:
    # [private] show env using poetry
    cmds:
      - echo "Creating virtualenv in .venv"
      - python --version
      - poetry env list
      - poetry env info

  setuptools-show-env:
    # [private] show the environment
    cmds:
      - python --version
      - echo 'TODO setuptools show environment'

  unit-tests:
    # [private] Run the unit tests for the supported versions of python.
    cmds:
      # hatch supports matrix testing for multiple python coverage
      - "{{.TEST_RUNNER}} test"

  update-venv:
    cmds:
      # [private] update development virtual environment
      - "{{.DEV_RUNNER}} pip install --upgrade pip"
      # install project into virtual environment
      - "{{.DEV_RUNNER}} pip install --no-deps -e ."

  hatch_lockfiles_enable:
    desc: Enable hatch backend to use requirements.txt files managed by pip-compile as lock files.
    cmds:
      - '{{.DEV_RUNNER}} toml set --toml-path pyproject.toml 
       tool.hatch.env.requires --to-array "[\"hatch-pip-compile\"]"'
      - '{{.DEV_RUNNER}} toml set --toml-path pyproject.toml 
       tool.hatch.envs.default.type "pip-compile"'

  hatch_lockfiles_disable:
    desc: Disable hatch backend to use requirements.txt files managed by pip-compile as lock files.
    cmds:
      - '{{.DEV_RUNNER}} toml set --toml-path pyproject.toml 
       tool.hatch.env.requires --to-array "[]"'
      - '{{.DEV_RUNNER}} toml set --toml-path pyproject.toml 
       tool.hatch.envs.default.type "virtual"'
