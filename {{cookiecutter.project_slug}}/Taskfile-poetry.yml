# SPDX-FileCopyrightText: 2024 Roy Wright
#
# SPDX-License-Identifier: MIT

version: "3"

tasks:
  default:
    cmds:
      - task --list

  init:
    desc: initialize new project (only run once upon first creation of project).
    cmds:
      - git init .
      - git add docs LICENSES scripts src tests .gitignore
        .pre-commit-config.yaml DEV-README.md mkdocs.yml pyproject.toml
        README.md Taskfile-hatch.yml Taskfile-poetry.yml tox.ini
      # Realizing the template can mess up formatting of the files
      - pre-commit run blacken-docs --all-files >/dev/null || true
      - pre-commit run trailing-whitespace --all-files >/dev/null || true
      - pre-commit run prettier --all-files >/dev/null || true
      - pre-commit run ruff --all-files >/dev/null || true
      - git commit -m "Initial Framework."
      - poetry install

  show-env:
    # [private] show the environment
    cmds:
      - python --version
      - poetry env list
      - poetry env info

  update-venv:
    cmds:
      # [private] update development virtual environment
      - poetry update
      # install project into virtual environment
      - poetry install

  validate-pyproject:
    cmds:
      # [private] validate the pyproject.toml file
      - poetry check
      - poetry run -- validate-pyproject pyproject.toml

  lint:
    desc: Perform static code analysis.
    cmds:
      - poetry run -- ruff check --config pyproject.toml --fix src tests
      - poetry run -- scripts/run-mypy-all-python-versions.sh
      - poetry run -- fawltydeps --detailed || true
      - poetry run -- reuse lint
      - poetry run -- pyupgrade --py311-plus
      # Disallow improper capitalization
      - scripts/fail_on_regex_match.sh "PyBind|Numpy|Cmake|CCache|Github|PyTest"
      # lint shell scripts
      - git ls-files -z -- "*.sh" | xargs -0 poetry run -- shellcheck

  format:
    desc: Check and reformat the code to a coding standard.
    cmds:
      - poetry run -- ruff format --config pyproject.toml src tests
      - git ls-files -z -- '*.md' '*.py' | xargs -0 --verbose poetry run --
        blacken-docs

  check-pyproject:
    desc:
      Check the consistency between poetry and hatch in the pyproject.toml file.
    cmds:
      # check that project and tool.poetry tables are in sync
      - poetry run -- .venv/bin/python3 -m check_pyproject --loglevel INFO

  check-licenses:
    desc: Check that all dependency licenses are acceptable for this project.
    cmds:
      # check licenses
      - poetry run -- liccheck -s pyproject.toml
      # add any missing copyrights
      - git diff --name-only --cached | xargs -I {} poetry run -- reuse annotate
        --skip-unrecognised -c "$(git config --get user.name)" "{}"
      # create software bill of materials
      - poetry run -- reuse spdx -o reuse.spdx

  pre-commit:
    desc: Must pass before allowing version control commit.
    # called from the "pre-commit" hook and the "task build"
    cmds:
      - task: check-pyproject

  build:
    desc: Build the project.
    summary: |
      Build the project

      Format the project, check for code quality, check for compliance,
      perform unit testing, build distributables, build documentation,
      and run the application to display its version.
    cmds:
      # show project's environment
      - task: show-env
      # format the source code
      - task: format
      # check for programming errors/warnings
      - task: lint
      # check that code can be committed to vcs
      - pre-commit run --all-files
      # create dist packages
      - poetry build
      # install current build into dev virtual environment
      - task: update-venv
      # generate code metrics
      - task: check-licenses
      # run unit test and generate coverage reports
      - task: coverage
      # generate code metrics
      - task: metrics
      # build documentation
      - task: build-docs
      # actually run the built application, getting its version
      - task: version

  version:
    desc: Run the project, having it return its version.
    cmds:
      - poetry run -- python3 -m {{cookiecutter.project_slug}} --version

  metrics:
    desc: Analyze the code.
    cmds:
      - bash -c "mkdir -p metrics"
      - poetry run -- radon cc --show-complexity --json --min=A
        --output-file=metrics/code-complexity.json src/
      - poetry run -- radon cc --show-complexity --min=A src/ -- | tail -n +1 |
        head -10
      - poetry run -- radon hal --json
        --output-file=metrics/halstead-metrics.json src/
      - poetry run -- radon mi --json
        --output-file=metrics/maintainability-index.json src/
      - poetry run -- radon raw --json --output-file=metrics/raw-metrics.json
        src/

  tests:
    desc: Run the unit tests for the supported versions of python.
    cmds:
      - poetry run -- pytest tests
      - poetry run -- tox

  coverage:
    desc: Run the unit tests with coverage.
    cmds:
      - poetry run -- pytest --cov-report term-missing --cov-report
        json:metrics/coverage.json --cov={{cookiecutter.project_slug}} tests

  docs:
    desc: Create the project documentation and open in the browser.
    cmds:
      - task: build-docs
      - task: serve-docs

  build-docs:
    desc: Build the documentation.
    cmds:
      - poetry run mkdocs build

  serve-docs:
    desc: Start the documentation server and open browser at localhost:8000.
    cmds:
      - poetry run mkdocs serve --open

  clean:
    desc: Remove virtual environments and generated files.
    cmds:
      - poetry env remove --all
      - rm -rf .tox
      - rm -rf .nox
      - rm -rf dist
      - rm -rf metrics
      - rm -rf site
      - rm -rf tests/__pycache__
      - rm -rf .*_cache
      - rm -rf poetry.lock

  switch-to-hatch:
    desc: Switch development to use hatch instead of poetry.
    cmds:
      - poetry run -- python3 scripts/swap_build_system.py hatch
      - task: clean
      - rm -rf Taskfile.yml ; ln -s Taskfile-hatch.yml Taskfile.yml
      - hatch run echo "Creating virtualenv in .venv"
      # show env using hatch
      - python --version
      - hatch env show

  switch-to-poetry:
    desc: Switch development to use poetry instead of hatch.
    cmds:
      - poetry run -- python3 scripts/swap_build_system.py poetry
      - task: clean
      - rm -rf Taskfile.yml ; ln -s Taskfile-poetry.yml Taskfile.yml
      - poetry config virtualenvs.in-project true
      - poetry lock
      - poetry install
      - task: show-env

  main:
    desc:
      "Run the __main__ module code, passing arguments to the module.  Example:
      task main -- --version"
    cmds:
      - poetry run python3 -m {{cookiecutter.project_slug}} {{ '{{' }}.CLI_ARGS{{ '}}' }}
